<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHub</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      color-scheme: light;
      --bg: #eef3f1;
      --panel: #f9fbfa;
      --panel-strong: #ffffff;
      --border: #cfdad6;
      --text: #173238;
      --muted: #5e7b7a;
      --accent: #2f6f78;
      --accent-soft: #e0eeeb;
      --sand: #e2d2bb;
      --ok: #2f7a56;
      --error: #b1484a;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Avenir Next", "Inter", "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f4f8f7 0%, var(--bg) 35%, #e6efec 100%);
      color: var(--text);
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: color-mix(in srgb, var(--panel-strong) 92%, var(--sand) 8%);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 1.2rem;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
      gap: 10px;
      align-items: end;
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 0.8rem;
      color: var(--muted);
      gap: 4px;
    }

    input, button, textarea, select {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      font: inherit;
      background: #fdfefe;
      color: var(--text);
    }

    button {
      cursor: pointer;
      background: linear-gradient(135deg, #3f7e87 0%, var(--accent) 100%);
      color: white;
      border-color: #2c646c;
      font-weight: 600;
      box-shadow: 0 6px 16px rgba(47, 111, 120, 0.22);
    }

    button.secondary {
      background: var(--panel-strong);
      color: var(--accent);
      border-color: #9cb5b2;
      box-shadow: none;
    }

    main {
      padding: 14px;
      display: grid;
      gap: 14px;
      grid-template-columns: 2fr 1fr;
      min-height: calc(100vh - 104px);
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 12px 28px rgba(22, 56, 62, 0.08);
    }

    .card h2 {
      margin: 0;
      font-size: 1rem;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #f2f7f6 100%);
    }

    #map {
      height: 420px;
      width: 100%;
    }

    .split {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92rem;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 8px 10px;
      text-align: left;
      vertical-align: top;
    }

    tbody tr:hover {
      background: var(--accent-soft);
      cursor: pointer;
    }

    .detail {
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .field {
      display: grid;
      gap: 4px;
      font-size: 0.88rem;
      color: var(--muted);
    }

    .field input, .field textarea {
      color: var(--text);
    }

    .sample-preview {
      padding: 10px 12px;
      font-size: 0.85rem;
      color: var(--muted);
      border-top: 1px solid var(--border);
      background: #fdfefe;
    }

    .sample-preview div + div {
      margin-top: 4px;
    }

    .sheet-embed {
      width: 100%;
      border: 0;
      height: 420px;
      background: #ffffff;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .view-switch {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 6px;
    }

    .view-switch button {
      background: #fdfefe;
      color: var(--accent);
      border-color: var(--accent);
      font-weight: 600;
    }

    .view-switch button.active {
      background: var(--accent);
      color: #fff;
    }

    .view-panel.hidden {
      display: none;
    }

    .progress-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 8px;
    }

    .progress-list li {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      background: #fdfefe;
    }

    .progress-list li.complete {
      border-color: #9ccab0;
      background: #eef9f2;
    }

    .status {
      padding: 8px 12px;
      font-size: 0.85rem;
      border-radius: 10px;
      background: #f4f8f7;
      border: 1px solid var(--border);
      display: inline-block;
    }
    .status.ok { color: var(--ok); }
    .status.error { color: var(--error); }

    .left-nav {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 74px;
      background: linear-gradient(180deg, #fdfdfc 0%, #e9f0ee 100%);
      border-right: 1px solid var(--border);
      padding: 12px 8px;
      display: grid;
      align-content: start;
      gap: 10px;
      z-index: 1100;
    }

    .left-nav.hidden {
      display: none;
    }

    .nav-icon {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: #fdfefe;
      display: grid;
      place-items: center;
      padding: 0;
    }

    .line-icon {
      width: 28px;
      height: 28px;
      display: block;
    }

    .line-icon path,
    .line-icon circle,
    .line-icon rect,
    .line-icon polyline,
    .line-icon line {
      fill: none;
      stroke: #2f6f78;
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .nav-icon.active {
      background: linear-gradient(145deg, #3f7e87 0%, var(--accent) 100%);
      border-color: #2f6f78;
      box-shadow: 0 8px 18px rgba(47, 111, 120, 0.28);
    }

    .nav-icon.active .line-icon path,
    .nav-icon.active .line-icon circle,
    .nav-icon.active .line-icon rect,
    .nav-icon.active .line-icon polyline,
    .nav-icon.active .line-icon line {
      stroke: #d8eef0;
    }

    .nav-spacer { height: 8px; }

    .with-sidebar {
      /* kept for backwards compatibility; overridden when logged in */
      margin-left: 72px;
    }

    body.has-sidebar header {
      margin-left: 74px;
    }

    body.has-sidebar main.with-sidebar {
      margin-left: 74px;
    }

    .app-screen.hidden {
      display: none;
    }

    .header-hidden {
      display: none;
    }

    .auth-wrap {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 20px;
    }

    .auth-card {
      width: min(460px, 100%);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      display: grid;
      gap: 10px;
    }

    .subtle {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .funding-grid {
      padding: 10px 12px;
      overflow: auto;
    }

    .funding-badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      background: #e9f1ff;
      color: #1d4ea8;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .highlight-pill {
      display: inline-block;
      margin-left: 6px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 700;
      color: #895000;
      background: #fff0cc;
      border: 1px solid #f0cc7d;
    }

    tr.highlight-row {
      background: #fff9e8;
    }

    .custom-marker {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #ffffff;
      box-shadow: 0 1px 6px rgba(0,0,0,.35);
      background: #1f77f2;
    }

    .custom-marker.highlight {
      background: #f6a800;
      width: 19px;
      height: 19px;
    }

    @media (max-width: 1100px) {
      .controls { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      main { grid-template-columns: 1fr; }
      .left-nav { width: 58px; }
      .nav-icon { width: 42px; height: 42px; }
      .with-sidebar { margin-left: 58px; }
    }
  </style>
</head>
<body>
  <header id="appHeader" class="header-hidden">
    <h1>CHub for Homes</h1>
    <div class="controls">
      <label>Google Sheet ID
        <input id="sheetId" placeholder="1Abc..." />
      </label>
      <label>Tab GID
        <input id="gid" placeholder="0" value="0" />
      </label>
      <label>Write Endpoint (optional)
        <input id="writeEndpoint" placeholder="https://script.google.com/..." />
      </label>
      <label>Latitude Column
        <input id="latColumn" value="Latitude" />
      </label>
      <label>Longitude Column
        <input id="lngColumn" value="Longitude" />
      </label>
      <button id="loadBtn">Refresh Sheet</button>
    </div>
    <div id="status" class="status">
      Google Sheets backend is configured for Winnipeg, Manitoba.
      Click Refresh Sheet to sync map, list, and details.
    </div>
  </header>

  <aside id="leftNav" class="left-nav hidden" aria-label="App navigation">
    <button type="button" id="operationsScreenBtn" class="nav-icon active" title="Operations" aria-label="Operations">
      <svg class="line-icon" viewBox="0 0 24 24" aria-hidden="true">
        <polyline points="3,15 8,10 12,13 18,7 21,9" />
        <line x1="3" y1="19" x2="21" y2="19" />
      </svg>
    </button>
    <button type="button" id="fundingScreenBtn" class="nav-icon" title="Funding" aria-label="Funding">
      <svg class="line-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 3v18" />
        <path d="M16.5 7.5c0-1.5-1.8-2.5-4.5-2.5s-4.5 1-4.5 2.5 1.6 2.2 4.5 2.8c2.9.6 4.5 1.3 4.5 2.9S14.7 16 12 16s-4.5-1-4.5-2.5" />
      </svg>
    </button>
    <button type="button" id="connectionsScreenBtn" class="nav-icon" title="Connections" aria-label="Connections">
      <svg class="line-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M9 7h6" />
        <path d="M9 17h6" />
        <rect x="3" y="5" width="6" height="4" rx="1.2" />
        <rect x="15" y="5" width="6" height="4" rx="1.2" />
        <rect x="3" y="15" width="6" height="4" rx="1.2" />
        <rect x="15" y="15" width="6" height="4" rx="1.2" />
        <line x1="9" y1="7" x2="15" y2="7" />
        <line x1="9" y1="17" x2="15" y2="17" />
      </svg>
    </button>
    <button type="button" id="auditScreenBtn" class="nav-icon" title="Audit Trail" aria-label="Audit Trail">
      <svg class="line-icon" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="5" y="3" width="14" height="18" rx="2" />
        <line x1="8" y1="8" x2="16" y2="8" />
        <line x1="8" y1="12" x2="16" y2="12" />
        <line x1="8" y1="16" x2="13" y2="16" />
      </svg>
    </button>
    <div class="nav-spacer"></div>
    <button type="button" id="logoutBtn" class="nav-icon" title="Logout" aria-label="Logout">
      <svg class="line-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M10 4H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4" />
        <polyline points="13,8 19,12 13,16" />
        <line x1="19" y1="12" x2="9" y2="12" />
      </svg>
    </button>
  </aside>

  <main id="loginScreen" class="app-screen auth-wrap">
    <section class="auth-card">
      <h2>Login</h2>
      <div class="subtle">
        Use your dashboard credentials to access operations, funding, connections, and audit trail.
      </div>
      <label>Username
        <input id="loginUsername" placeholder="admin" />
      </label>
      <label>Password
        <input id="loginPassword" type="password" placeholder="••••••••" />
      </label>
      <button type="button" id="loginBtn">Sign In</button>
      <div class="subtle">Demo account: <code>admin</code> / <code>connection123</code></div>
    </section>
  </main>

  <main id="operationsScreen" class="app-screen hidden with-sidebar">
    <section class="split">
      <article class="card">
        <h2>Map View (click a marker for project details)</h2>
        <div id="map"></div>
      </article>
      <article class="card">
        <h2>Development List View</h2>
        <table>
          <thead>
            <tr>
              <th>Development</th>
              <th>Address</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="projectRows"></tbody>
        </table>
      </article>
    </section>

    <aside class="card">
      <h2>Project Details (live from Google Sheets)</h2>
      <form id="detailForm" class="detail">
        <div class="view-switch">
          <button type="button" id="detailsViewBtn" class="active">Details View</button>
          <button type="button" id="progressViewBtn">Progress View</button>
        </div>

        <section id="detailsPanel" class="view-panel">
          <div class="field"><label>Development Name<input name="development"></label></div>
          <div class="field"><label>Address<input name="address"></label></div>
          <div class="field"><label>Status<input name="status"></label></div>
          <div class="field"><label>Total Lots<input name="lots"></label></div>
          <div class="field"><label>Manager<input name="manager"></label></div>
          <div class="field"><label>Budget<input name="budget"></label></div>
          <div class="field">
            <label>Funding Source
              <select name="fundingSource">
                <option value="SCU">SCU</option>
                <option value="ProAuto">ProAuto</option>
                <option value="Client-funded">Client-funded</option>
                <option value="Unknown">Unknown</option>
              </select>
            </label>
          </div>
          <div class="field"><label>Draw Requested (%)<input name="drawRequested" placeholder="0-100"></label></div>
          <div class="field"><label>Draw Approved (%)<input name="drawApproved" placeholder="0-100"></label></div>
          <div class="field"><label>Last Updated<input name="lastUpdated"></label></div>
          <div class="field"><label>Notes<textarea rows="4" name="notes"></textarea></label></div>
        </section>

        <section id="progressPanel" class="view-panel hidden">
          <ul id="progressTimeline" class="progress-list"></ul>
          <div class="field">
            <label>Lot Secured
              <select name="stageLotSecured">
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Complete">Complete</option>
              </select>
            </label>
          </div>
          <div class="field">
            <label>Financing Approved
              <select name="stageFinancing">
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Complete">Complete</option>
              </select>
            </label>
          </div>
          <div class="field">
            <label>Legal Complete
              <select name="stageLegal">
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Complete">Complete</option>
              </select>
            </label>
          </div>
          <div class="field">
            <label>Pre-sale Complete
              <select name="stagePresale">
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Complete">Complete</option>
              </select>
            </label>
          </div>
          <div class="field">
            <label>Foundation Dig
              <select name="stageFoundation">
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Complete">Complete</option>
              </select>
            </label>
          </div>
          <div class="field">
            <label>Framing
              <select name="stageFraming">
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Complete">Complete</option>
              </select>
            </label>
          </div>
          <div class="field">
            <label>Key Handoff
              <select name="stageHandoff">
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Complete">Complete</option>
              </select>
            </label>
          </div>
        </section>

        <input type="hidden" name="rowNumber" />
        <div class="actions">
          <button type="submit">Save to Sheet</button>
          <button type="button" class="secondary" id="reloadBtn">Reload Active Project</button>
        </div>
      </form>
    </aside>
  </main>

  <main id="fundingScreen" class="app-screen hidden with-sidebar">
    <section class="card" style="grid-column:1 / -1;">
      <h2>Funding + Draw Progress by Property</h2>
      <div class="funding-grid">
        <table>
          <thead>
            <tr>
              <th>Development</th>
              <th>Address</th>
              <th>Lender</th>
              <th>Critical Stage Progress</th>
              <th>Draw Requested</th>
              <th>Draw Approved</th>
              <th>Funded to Build</th>
            </tr>
          </thead>
          <tbody id="fundingRows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <main id="connectionsScreen" class="app-screen hidden with-sidebar">
    <section class="card" style="grid-column:1 / -1;">
      <h2>Data Connections + Local Cache DB</h2>
      <div class="detail">
        <div class="field">
          <label>Connection Name<input id="connectionName" placeholder="Winnipeg Main Sheet" /></label>
        </div>
        <div class="field">
          <label>Source Type
            <select id="sourceType">
              <option value="google_sheet">Google Sheet</option>
              <option value="json_url">JSON URL</option>
              <option value="csv_url">CSV URL</option>
            </select>
          </label>
        </div>
        <div class="field">
          <label>Sheet ID / URL<input id="sourceRef" placeholder="Sheet ID or URL" /></label>
        </div>
        <div class="field">
          <label>Tab GID / Path<input id="sourcePath" placeholder="0" value="0" /></label>
        </div>
        <div class="actions">
          <button type="button" id="saveConnectionBtn">Save Connection</button>
          <button type="button" class="secondary" id="useConnectionBtn">Use Selected Connection</button>
          <button type="button" class="secondary" id="deleteConnectionBtn">Delete Selected</button>
        </div>
      </div>
    </section>

    <section class="card" id="sampleCard">
      <h2>Sample data from Google Sheet</h2>
      <div class="sample-preview">
        <div id="samplePreview">No data loaded yet.</div>
      </div>
    </section>

    <section class="card">
      <h2>Embedded Sheet (read-only)</h2>
      <div class="funding-grid">
        <iframe id="sheetEmbed" class="sheet-embed" title="Embedded Google Sheet"></iframe>
      </div>
    </section>

    <section class="card">
      <h2>Saved Connections</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Reference</th>
            <th>Path/GID</th>
          </tr>
        </thead>
        <tbody id="connectionRows"></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Local Cache DB (Browser)</h2>
      <div class="funding-grid">
        <table>
          <thead>
          <tr>
            <th>Connection</th>
            <th>Rows</th>
            <th>Columns</th>
            <th>Last Sync</th>
          </tr>
          </thead>
          <tbody id="cacheRows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <main id="auditScreen" class="app-screen hidden with-sidebar">
    <section class="card" style="grid-column:1 / -1;">
      <h2>Audit Trail</h2>
      <div class="funding-grid">
        <table>
          <thead>
          <tr>
            <th>Timestamp</th>
            <th>User</th>
            <th>Action</th>
            <th>Details</th>
          </tr>
          </thead>
          <tbody id="auditRows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <script>
    const DEFAULT_COLUMNS = {
      development: ["Development", "Development Name", "Project", "Lot-Block-Plan", "Lot Block Plan"],
      address: ["Address", "Site Address", "Civic Address"],
      status: ["Status"],
      manager: ["Manager", "Project Manager"],
      budget: ["Budget", "Purchase"],
      lastUpdated: ["Last Updated", "Updated At"],
      notes: ["Notes", "Description"],
      lots: ["Lots", "Total Lots", "Lot Count", "Available Lots"],
      fundingSource: ["Funding Source", "Lender", "Primary Lender", "Funding"],
      drawRequested: ["Draw Requested", "Draw Request %", "Progress Draw Requested"],
      drawApproved: ["Draw Approved", "Draw Approved %", "Progress Draw Approved"],
      stageLotSecured: ["Stage - Lot Secured", "Lot Secured"],
      stageFinancing: ["Stage - Financing", "Financing"],
      stageLegal: ["Stage - Legal", "Legal"],
      stagePresale: ["Stage - Presale", "Pre-sale", "Presale"],
      stageFoundation: ["Stage - Foundation", "Foundation Dig", "Foundation"],
      stageFraming: ["Stage - Framing", "Framing"],
      stageHandoff: ["Stage - Key Handoff", "Key Handoff", "Handoff"],
    };

    const STAGE_ORDER = [
      { key: "stageLotSecured", label: "Lot Secured" },
      { key: "stageFinancing", label: "Financing Approved" },
      { key: "stageLegal", label: "Legal Complete" },
      { key: "stagePresale", label: "Pre-sale Complete" },
      { key: "stageFoundation", label: "Foundation Dig" },
      { key: "stageFraming", label: "Framing" },
      { key: "stageHandoff", label: "Key Handoff" },
    ];

    const state = {
      records: [],
      active: null,
      headers: [],
      markers: [],
      connections: [],
      selectedConnectionId: null,
      cacheDb: {},
      currentUser: null,
      auditTrail: [],
    };

    const CONNECTIONS_KEY = "connection_dashboard_connections_v1";
    const CACHE_DB_KEY = "connection_dashboard_cache_db_v1";
    const AUTH_KEY = "connection_dashboard_auth_v1";
    const AUDIT_KEY = "connection_dashboard_audit_v1";
    const USERS = [{ username: "admin", password: "connection123", role: "admin" }];

    const WINNIPEG_CENTER = { lat: 49.8951, lng: -97.1384 };
    const DEFAULT_REGION_SUFFIX = "Winnipeg, Manitoba";

    const map = L.map("map").setView([WINNIPEG_CENTER.lat, WINNIPEG_CENTER.lng], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);
    const markerLayer = L.layerGroup().addTo(map);

    const statusEl = document.getElementById("status");

    function setStatus(message, mode = "") {
      statusEl.textContent = message;
      statusEl.className = `status ${mode}`;
    }

    function updateSheetEmbed(source) {
      const iframe = document.getElementById("sheetEmbed");
      if (!iframe) return;
      const raw = (source || "").trim();
      if (!raw || !raw.includes("docs.google.com") || !raw.includes("/pubhtml")) {
        iframe.src = "";
        return;
      }
      iframe.src = raw;
    }

    function parseSheetRef(idValue, gidValue) {
      const raw = (idValue || "").trim();
      const fallbackGid = (gidValue || "").trim() || "0";
      if (!raw) return { sheetId: "", gid: fallbackGid };
      if (!raw.includes("docs.google.com")) {
        // Treat as plain document ID
        return { sheetId: raw, gid: fallbackGid };
      }
      try {
        const url = new URL(raw);
        const parts = url.pathname.split("/").filter(Boolean);
        // Supports:
        // - /spreadsheets/d/<DOC_ID>/edit...
        // - /spreadsheets/d/e/<PUB_ID>/pubhtml...
        let sheetId = "";
        const dIndex = parts.indexOf("d");
        if (dIndex >= 0) {
          const afterD = parts[dIndex + 1];
          const afterAfterD = parts[dIndex + 2];
          if (afterD === "e" && afterAfterD) {
            // published-to-web ID: we keep "e/<PUB_ID>" so URL becomes /d/e/<PUB_ID>/gviz/tq
            sheetId = `e/${afterAfterD}`;
          } else if (afterD) {
            sheetId = afterD;
          }
        }
        const gidMatchHash = url.hash.match(/gid=(\d+)/);
        const gidMatchQuery = url.search.match(/gid=(\d+)/);
        const gid = (gidMatchHash && gidMatchHash[1]) || (gidMatchQuery && gidMatchQuery[1]) || fallbackGid;
        return { sheetId, gid };
      } catch {
        return { sheetId: raw, gid: fallbackGid };
      }
    }

    function findHeaderIndex(headers, candidates) {
      const normalized = headers.map((h) => h.toLowerCase().trim());
      for (const name of candidates) {
        const idx = normalized.indexOf(name.toLowerCase());
        if (idx > -1) return idx;
      }
      return -1;
    }

    async function fetchPublishedCsvTable(sheetId, gid) {
      // sheetId is expected to look like "e/<PUBLIC_ID>" from parseSheetRef
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/pub?gid=${gid}&single=true&output=csv`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(
          `Unable to read published Google Sheet (CSV) (HTTP ${response.status}). ` +
          `Check that the sheet is published to the web and the URL is correct.`
        );
      }
      const text = await response.text();
      const lines = text.split(/\r?\n/).filter((line) => line.trim().length > 0);
      if (!lines.length) {
        return { cols: [], rows: [] };
      }
      const cellsFromLine = (line) => {
        // Very simple CSV split; good enough for this sheet (no embedded commas in values)
        return line.split(",").map((cell) => cell.replace(/^"|"$/g, ""));
      };
      const headerCells = cellsFromLine(lines[0]);
      const cols = headerCells.map((label, idx) => ({ id: String(idx), label }));
      const rows = lines.slice(1).map((line) => ({
        c: cellsFromLine(line).map((v) => ({ v })),
      }));
      return { cols, rows };
    }

    async function fetchSheetRows(sheetId, gid) {
      // For published-to-web sheets, we use the CSV endpoint instead of gviz JSON.
      if (sheetId.startsWith("e/")) {
        return fetchPublishedCsvTable(sheetId, gid);
      }
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?gid=${gid}&tqx=out:json`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(
          `Unable to read Google Sheet (HTTP ${response.status}). ` +
          `Check that the sheet is shared as "Anyone with the link" (or Published to the web) and that the ID / gid are correct.`
        );
      }
      const text = await response.text();
      const json = JSON.parse(text.substring(47, text.length - 2));
      return json.table;
    }

    function withDefaultRegion(address) {
      if (!address) return "";
      const normalized = address.toLowerCase();
      const hasRegion = normalized.includes("winnipeg") || normalized.includes("manitoba") || normalized.includes("mb");
      return hasRegion ? address : `${address}, ${DEFAULT_REGION_SUFFIX}`;
    }

    async function geocode(address) {
      const geocodeQuery = withDefaultRegion(address);
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(geocodeQuery)}`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      const data = await res.json();
      if (data.length === 0) return null;
      return { lat: Number(data[0].lat), lng: Number(data[0].lon) };
    }

    function parseLots(value) {
      const raw = String(value ?? "").trim();
      if (!raw) return 0;
      const match = raw.replace(/,/g, "").match(/-?\d+(?:\.\d+)?/);
      return match ? Number(match[0]) : 0;
    }

    function isHighlightedDevelopment(record) {
      const development = (record.development || "").toLowerCase();
      const keyDevelopments = ["forest grove", "grande pointe"];
      const hasPriorityName = keyDevelopments.some((name) => development.includes(name));
      return hasPriorityName || record.lotsCount > 0;
    }

    function markerIcon(record) {
      const highlighted = record.highlighted ? " highlight" : "";
      return L.divIcon({
        className: "",
        html: `<span class="custom-marker${highlighted}"></span>`,
        iconSize: record.highlighted ? [19, 19] : [16, 16],
        iconAnchor: record.highlighted ? [9, 9] : [8, 8],
        popupAnchor: [0, -10],
      });
    }

    function stageStatusValue(value) {
      const normalized = String(value || "").toLowerCase();
      if (["complete", "completed", "done", "yes"].some((v) => normalized.includes(v))) return "Complete";
      if (["in progress", "active", "started"].some((v) => normalized.includes(v))) return "In Progress";
      return "Not Started";
    }

    function renderProgressTimeline(rec) {
      const timeline = document.getElementById("progressTimeline");
      timeline.innerHTML = "";

      STAGE_ORDER.forEach((stage, index) => {
        const status = stageStatusValue(rec[stage.key]);
        const li = document.createElement("li");
        li.className = status === "Complete" ? "complete" : "";
        li.innerHTML = `<strong>${index + 1}. ${stage.label}</strong><br>${status}`;
        timeline.appendChild(li);
      });
    }

    function setProjectView(mode) {
      const detailsPanel = document.getElementById("detailsPanel");
      const progressPanel = document.getElementById("progressPanel");
      const detailsBtn = document.getElementById("detailsViewBtn");
      const progressBtn = document.getElementById("progressViewBtn");
      const isProgress = mode === "progress";

      detailsPanel.classList.toggle("hidden", isProgress);
      progressPanel.classList.toggle("hidden", !isProgress);
      detailsBtn.classList.toggle("active", !isProgress);
      progressBtn.classList.toggle("active", isProgress);
    }

    function renderAuditTrail() {
      const body = document.getElementById("auditRows");
      if (!body) return;
      body.innerHTML = "";
      [...state.auditTrail].reverse().forEach((item) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${new Date(item.ts).toLocaleString()}</td><td>${item.user || "anonymous"}</td><td>${item.action}</td><td>${item.details || ""}</td>`;
        body.appendChild(tr);
      });
    }

    function addAudit(action, details = "") {
      state.auditTrail.push({ ts: Date.now(), user: state.currentUser?.username || "anonymous", action, details });
      if (state.auditTrail.length > 2000) state.auditTrail = state.auditTrail.slice(-2000);
      savePersistedState();
      renderAuditTrail();
    }

    function setAuthState(isLoggedIn) {
      document.body.classList.toggle("has-sidebar", isLoggedIn);
      document.getElementById("appHeader").classList.toggle("header-hidden", !isLoggedIn);
      document.getElementById("leftNav").classList.toggle("hidden", !isLoggedIn);
      document.getElementById("loginScreen").classList.toggle("hidden", isLoggedIn);
      if (!isLoggedIn) {
        document.getElementById("operationsScreen").classList.add("hidden");
        document.getElementById("fundingScreen").classList.add("hidden");
        document.getElementById("connectionsScreen").classList.add("hidden");
        document.getElementById("auditScreen").classList.add("hidden");
      }
    }

    function attemptLogin() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value;
      const user = USERS.find((u) => u.username === username && u.password === password);
      if (!user) {
        setStatus("Invalid login credentials.", "error");
        addAudit("login_failed", `username=${username || "(blank)"}`);
        return;
      }
      state.currentUser = { username: user.username, role: user.role };
      savePersistedState();
      setAuthState(true);
      setScreen("operations");
      addAudit("login_success", `role=${user.role}`);
      setStatus(`Welcome ${user.username}.`, "ok");
    }

    function logout() {
      const who = state.currentUser?.username || "unknown";
      addAudit("logout", `user=${who}`);
      state.currentUser = null;
      savePersistedState();
      setAuthState(false);
      document.getElementById("loginPassword").value = "";
    }

    function uid() {
      return `${Date.now()}-${Math.random().toString(16).slice(2, 8)}`;
    }

    function loadPersistedState() {
      try {
        state.connections = JSON.parse(localStorage.getItem(CONNECTIONS_KEY) || "[]");
      } catch {
        state.connections = [];
      }
      try {
        state.cacheDb = JSON.parse(localStorage.getItem(CACHE_DB_KEY) || "{}");
      } catch {
        state.cacheDb = {};
      }
      try {
        state.auditTrail = JSON.parse(localStorage.getItem(AUDIT_KEY) || "[]");
      } catch {
        state.auditTrail = [];
      }
      try {
        state.currentUser = JSON.parse(localStorage.getItem(AUTH_KEY) || "null");
      } catch {
        state.currentUser = null;
      }
    }

    function savePersistedState() {
      localStorage.setItem(CONNECTIONS_KEY, JSON.stringify(state.connections));
      localStorage.setItem(CACHE_DB_KEY, JSON.stringify(state.cacheDb));
      localStorage.setItem(AUDIT_KEY, JSON.stringify(state.auditTrail));
      localStorage.setItem(AUTH_KEY, JSON.stringify(state.currentUser));
    }

    function renderConnections() {
      const body = document.getElementById("connectionRows");
      body.innerHTML = "";
      state.connections.forEach((conn) => {
        const tr = document.createElement("tr");
        if (conn.id === state.selectedConnectionId) tr.classList.add("highlight-row");
        tr.innerHTML = `<td>${conn.name}</td><td>${conn.type}</td><td>${conn.ref}</td><td>${conn.path || ""}</td>`;
        tr.addEventListener("click", () => {
          state.selectedConnectionId = conn.id;
          renderConnections();
        });
        body.appendChild(tr);
      });
    }

    function renderCacheDb() {
      const body = document.getElementById("cacheRows");
      body.innerHTML = "";
      Object.values(state.cacheDb).forEach((entry) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${entry.connectionName}</td><td>${entry.rows}</td><td>${entry.columns}</td><td>${new Date(entry.syncedAt).toLocaleString()}</td>`;
        body.appendChild(tr);
      });
    }

    function selectedConnection() {
      return state.connections.find((c) => c.id === state.selectedConnectionId) || null;
    }

    function applyConnectionToControls(conn) {
      if (!conn) return;
      if (conn.type === "google_sheet") {
        document.getElementById("sheetId").value = conn.ref || "";
        document.getElementById("gid").value = conn.path || "0";
      }
      updateSheetEmbed(conn.ref);
    }

    function saveConnection() {
      const name = document.getElementById("connectionName").value.trim();
      const type = document.getElementById("sourceType").value;
      const ref = document.getElementById("sourceRef").value.trim();
      const path = document.getElementById("sourcePath").value.trim();
      if (!name || !ref) {
        setStatus("Connection name and source reference are required.", "error");
        return;
      }
      const conn = { id: uid(), name, type, ref, path };
      state.connections.push(conn);
      state.selectedConnectionId = conn.id;
      savePersistedState();
      renderConnections();
      setStatus(`Saved connection: ${name}`, "ok");
      addAudit("connection_saved", `${name} (${type})`);
    }

    function deleteConnection() {
      if (!state.selectedConnectionId) return;
      state.connections = state.connections.filter((c) => c.id !== state.selectedConnectionId);
      delete state.cacheDb[state.selectedConnectionId];
      state.selectedConnectionId = state.connections[0]?.id || null;
      savePersistedState();
      renderConnections();
      renderCacheDb();
      setStatus("Deleted selected connection.", "ok");
      addAudit("connection_deleted", "selected connection removed");
    }

    async function fetchRowsForConnection(conn) {
      if (!conn || conn.type === "google_sheet") {
        let sheetId;
        let gid;
        if (conn) {
          const ref = parseSheetRef(conn.ref, conn.path);
          sheetId = ref.sheetId;
          gid = ref.gid;
        } else {
          const ref = parseSheetRef(
            document.getElementById("sheetId").value,
            document.getElementById("gid").value
          );
          sheetId = ref.sheetId;
          gid = ref.gid;
        }
        const table = await fetchSheetRows(sheetId, gid);
        return normalizeRecords(table);
      }
      if (conn.type === "json_url") {
        const res = await fetch(conn.ref);
        const json = await res.json();
        const arr = Array.isArray(json) ? json : [];
        return arr
          .map((row, i) => ({
            rowNumber: i + 1,
            development: String(row.development || row.project || ""),
            address: String(row.address || ""),
            status: String(row.status || ""),
            manager: String(row.manager || ""),
            budget: String(row.budget || ""),
            lastUpdated: String(row.lastUpdated || row.updatedAt || ""),
            notes: String(row.notes || ""),
            lots: String(row.lots || ""),
            fundingSource: normalizeLender(row.fundingSource || row.lender || "Unknown"),
            drawRequested: parsePercent(row.drawRequested || 0),
            drawApproved: parsePercent(row.drawApproved || 0),
            stageLotSecured: stageStatusValue(row.stageLotSecured),
            stageFinancing: stageStatusValue(row.stageFinancing),
            stageLegal: stageStatusValue(row.stageLegal),
            stagePresale: stageStatusValue(row.stagePresale),
            stageFoundation: stageStatusValue(row.stageFoundation),
            stageFraming: stageStatusValue(row.stageFraming),
            stageHandoff: stageStatusValue(row.stageHandoff),
            lat: Number(row.lat) || null,
            lng: Number(row.lng) || null,
          }))
          .map((rec) => ({
            ...rec,
            lotsCount: parseLots(rec.lots),
            highlighted: isHighlightedDevelopment(rec),
            criticalProgress: computeCriticalProgress(rec),
          }));
      }
      if (conn.type === "csv_url") {
        const res = await fetch(conn.ref);
        const text = await res.text();
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (lines.length < 2) return [];
        const headers = lines[0].split(",").map((h) => h.trim().toLowerCase());
        return lines.slice(1).map((line, idx) => {
          const cells = line.split(",");
          const get = (name) => cells[headers.indexOf(name)] || "";
          const rec = {
            rowNumber: idx + 1,
            development: get("development"),
            address: get("address"),
            status: get("status"),
            manager: get("manager"),
            budget: get("budget"),
            lastUpdated: get("last updated"),
            notes: get("notes"),
            lots: get("lots"),
            fundingSource: normalizeLender(get("funding source") || get("lender")),
            drawRequested: parsePercent(get("draw requested")),
            drawApproved: parsePercent(get("draw approved")),
            stageLotSecured: stageStatusValue(get("stage - lot secured")),
            stageFinancing: stageStatusValue(get("stage - financing")),
            stageLegal: stageStatusValue(get("stage - legal")),
            stagePresale: stageStatusValue(get("stage - presale")),
            stageFoundation: stageStatusValue(get("stage - foundation")),
            stageFraming: stageStatusValue(get("stage - framing")),
            stageHandoff: stageStatusValue(get("stage - key handoff")),
            lat: Number(get("latitude")) || null,
            lng: Number(get("longitude")) || null,
          };
          rec.lotsCount = parseLots(rec.lots);
          rec.highlighted = isHighlightedDevelopment(rec);
          rec.criticalProgress = computeCriticalProgress(rec);
          return rec;
        });
      }
      return [];
    }

    function normalizeLender(value) {
      const raw = String(value || "").trim();
      const l = raw.toLowerCase();
      if (l.includes("scu")) return "SCU";
      if (l.includes("proauto")) return "ProAuto";
      if (l.includes("client")) return "Client-funded";
      return raw || "Unknown";
    }

    function parsePercent(value) {
      const m = String(value ?? "").replace(",", "").match(/-?\d+(?:\.\d+)?/);
      if (!m) return 0;
      return Math.max(0, Math.min(100, Number(m[0])));
    }

    function computeCriticalProgress(record) {
      const done = STAGE_ORDER.filter((stage) => stageStatusValue(record[stage.key]) === "Complete").length;
      return Math.round((done / STAGE_ORDER.length) * 100);
    }

    function isFundedToBuild(record) {
      return stageStatusValue(record.stageFinancing) === "Complete" &&
        stageStatusValue(record.stageLegal) === "Complete";
    }

    function renderFundingScreen(records) {
      const body = document.getElementById("fundingRows");
      body.innerHTML = "";
      records.forEach((rec) => {
        const tr = document.createElement("tr");
        const funded = isFundedToBuild(rec) ? '<span class="funding-badge">Ready</span>' : "No";
        tr.innerHTML =
          `<td>${rec.development || "—"}</td>` +
          `<td>${rec.address || "—"}</td>` +
          `<td>${rec.fundingSource || "Unknown"}</td>` +
          `<td>${rec.criticalProgress}%</td>` +
          `<td>${rec.drawRequested}%</td>` +
          `<td>${rec.drawApproved}%</td>` +
          `<td>${funded}</td>`;
        tr.addEventListener("click", () => {
          setScreen("operations");
          selectProject(rec);
          setProjectView("progress");
        });
        body.appendChild(tr);
      });
    }

    function renderSamplePreview(records) {
      const container = document.getElementById("samplePreview");
      if (!container) return;
      if (!records.length) {
        container.textContent = "No rows found in this sheet yet.";
        return;
      }
      const samples = records.slice(0, 3);
      const headerLine =
        state.headers && state.headers.length
          ? `<div><strong>Headers:</strong> ${state.headers.join(" | ")}</div>`
          : "";
      const bodyLines = samples
        .map(
          (rec, index) =>
            `<div><strong>${index + 1}.</strong> ${rec.development || "(no development)"} — ${rec.address || "(no address)"} — ${rec.status || "(no status)"}</div>`
        )
        .join("");
      container.innerHTML = headerLine + bodyLines;
    }

    function setScreen(mode) {
      if (!state.currentUser) return;
      const operations = document.getElementById("operationsScreen");
      const funding = document.getElementById("fundingScreen");
      const connections = document.getElementById("connectionsScreen");
      const audit = document.getElementById("auditScreen");
      const operationsBtn = document.getElementById("operationsScreenBtn");
      const fundingBtn = document.getElementById("fundingScreenBtn");
      const connectionsBtn = document.getElementById("connectionsScreenBtn");
      const auditBtn = document.getElementById("auditScreenBtn");
      operations.classList.toggle("hidden", mode !== "operations");
      funding.classList.toggle("hidden", mode !== "funding");
      connections.classList.toggle("hidden", mode !== "connections");
      audit.classList.toggle("hidden", mode !== "audit");
      operationsBtn.classList.toggle("active", mode === "operations");
      fundingBtn.classList.toggle("active", mode === "funding");
      connectionsBtn.classList.toggle("active", mode === "connections");
      auditBtn.classList.toggle("active", mode === "audit");
      addAudit("screen_view", mode);
      if (mode === "operations") setTimeout(() => map.invalidateSize(), 50);
    }

    async function normalizeRecords(table) {
      // Try to infer which row actually contains the column headers.
      // This helps when the sheet uses row 3 (or another row) for headers.
      const allCanonicalNames = Object.values(DEFAULT_COLUMNS)
        .flat()
        .map((n) => n.toLowerCase());

      let headers = table.cols.map((c) => c.label || c.id || "");
      let headerRowIndex = -1;
      let bestMatchCount = -1;

      const candidateLimit = Math.min(table.rows.length, 5);
      for (let i = 0; i < candidateLimit; i++) {
        const cells = (table.rows[i] && table.rows[i].c) || [];
        const candidate = cells.map((cell) => String((cell && cell.v) ?? "").trim());
        if (!candidate.some(Boolean)) continue;

        let matches = 0;
        for (const h of candidate) {
          const hl = h.toLowerCase();
          if (allCanonicalNames.includes(hl)) matches++;
        }

        if (matches > bestMatchCount && matches >= 2) {
          bestMatchCount = matches;
          headerRowIndex = i;
          headers = candidate;
        }
      }

      state.headers = headers;
      const rows = [];

      const latIdx = findHeaderIndex(headers, [document.getElementById("latColumn").value]);
      const lngIdx = findHeaderIndex(headers, [document.getElementById("lngColumn").value]);

      const dataStart = headerRowIndex >= 0 ? headerRowIndex + 1 : 0;

      for (let i = dataStart; i < table.rows.length; i++) {
        const row = table.rows[i].c || [];
        const getVal = (names) => {
          const idx = findHeaderIndex(headers, names);
          return idx > -1 && row[idx] ? String(row[idx].v ?? "") : "";
        };

        const record = {
          // Approximate sheet row number (used when saving back)
          rowNumber: i + 2,
          development: getVal(DEFAULT_COLUMNS.development),
          address: getVal(DEFAULT_COLUMNS.address),
          status: getVal(DEFAULT_COLUMNS.status),
          manager: getVal(DEFAULT_COLUMNS.manager),
          budget: getVal(DEFAULT_COLUMNS.budget),
          lastUpdated: getVal(DEFAULT_COLUMNS.lastUpdated),
          notes: getVal(DEFAULT_COLUMNS.notes),
          lots: getVal(DEFAULT_COLUMNS.lots),
          fundingSource: normalizeLender(getVal(DEFAULT_COLUMNS.fundingSource)),
          drawRequested: parsePercent(getVal(DEFAULT_COLUMNS.drawRequested)),
          drawApproved: parsePercent(getVal(DEFAULT_COLUMNS.drawApproved)),
          stageLotSecured: stageStatusValue(getVal(DEFAULT_COLUMNS.stageLotSecured)),
          stageFinancing: stageStatusValue(getVal(DEFAULT_COLUMNS.stageFinancing)),
          stageLegal: stageStatusValue(getVal(DEFAULT_COLUMNS.stageLegal)),
          stagePresale: stageStatusValue(getVal(DEFAULT_COLUMNS.stagePresale)),
          stageFoundation: stageStatusValue(getVal(DEFAULT_COLUMNS.stageFoundation)),
          stageFraming: stageStatusValue(getVal(DEFAULT_COLUMNS.stageFraming)),
          stageHandoff: stageStatusValue(getVal(DEFAULT_COLUMNS.stageHandoff)),
          lat: latIdx > -1 && row[latIdx] ? Number(row[latIdx].v) : null,
          lng: lngIdx > -1 && row[lngIdx] ? Number(row[lngIdx].v) : null,
        };

        record.lotsCount = parseLots(record.lots);
        record.highlighted = isHighlightedDevelopment(record);
        record.criticalProgress = computeCriticalProgress(record);

        if ((!record.lat || !record.lng) && record.address) {
          record.geocoding = "pending";
          rows.push(record);
        } else {
          rows.push(record);
        }
      }

      for (const rec of rows) {
        if (rec.geocoding === "pending") {
          const point = await geocode(rec.address);
          if (point) {
            rec.lat = point.lat;
            rec.lng = point.lng;
          }
          delete rec.geocoding;
        }
      }

      return rows.filter((r) => r.address || r.development);
    }

    function renderList(records) {
      const body = document.getElementById("projectRows");
      body.innerHTML = "";
      records.forEach((rec) => {
        const tr = document.createElement("tr");
        if (rec.highlighted) tr.classList.add("highlight-row");
        const badge = rec.highlighted ? '<span class="highlight-pill">Lots Active</span>' : "";
        tr.innerHTML =
          `<td>${rec.development || "—"}${badge}</td>` +
          `<td>${rec.address || "—"}</td>` +
          `<td>${rec.status || "—"}</td>`;
        tr.addEventListener("click", () => selectProject(rec));
        body.appendChild(tr);
      });
    }

    function renderMap(records) {
      markerLayer.clearLayers();
      state.markers = [];
      const points = [];

      records.forEach((rec) => {
        if (Number.isFinite(rec.lat) && Number.isFinite(rec.lng)) {
          const lotsText = rec.lots ? `<br>Lots: ${rec.lots}` : "";
          const marker = L.marker([rec.lat, rec.lng], { icon: markerIcon(rec) })
            .addTo(markerLayer)
            .bindPopup(`<strong>${rec.development || "Project"}</strong><br>${rec.address || "No address"}${lotsText}`);
          marker.on("click", () => selectProject(rec));
          state.markers.push(marker);
          points.push([rec.lat, rec.lng]);
        }
      });

      if (points.length) {
        map.fitBounds(points, { padding: [20, 20] });
      } else {
        map.setView([WINNIPEG_CENTER.lat, WINNIPEG_CENTER.lng], 11);
      }
    }

    function selectProject(rec) {
      state.active = rec;
      const form = document.getElementById("detailForm");
      for (const [k, v] of Object.entries(rec)) {
        if (form.elements[k]) form.elements[k].value = v ?? "";
      }
      renderProgressTimeline(rec);
      setStatus(`Selected: ${rec.development || rec.address}`, "ok");
    }

    async function loadSheet() {
      const sheetInput = document.getElementById("sheetId").value;
      const gidInput = document.getElementById("gid").value;
      const { sheetId, gid } = parseSheetRef(sheetInput, gidInput);
      if (!sheetId) {
        setStatus("Enter a Google Sheet ID first.", "error");
        return;
      }

      setStatus("Refreshing data from Google Sheets backend and geocoding addresses...");
      try {
        updateSheetEmbed(sheetInput);
        const conn = selectedConnection();
        if (conn && conn.type === "google_sheet") {
          document.getElementById("sheetId").value = conn.ref;
          document.getElementById("gid").value = conn.path || "0";
        }
        state.records = await fetchRowsForConnection(conn);
        renderList(state.records);
        renderFundingScreen(state.records);
        renderMap(state.records);
        renderSamplePreview(state.records);
        if (state.records.length) {
          selectProject(state.records[0]);
        }
        const highlightedCount = state.records.filter((rec) => rec.highlighted).length;
        const cacheKey = state.selectedConnectionId || "adhoc-google-sheet";
        state.cacheDb[cacheKey] = {
          connectionName: selectedConnection()?.name || "Adhoc Google Sheet",
          rows: state.records.length,
          columns: state.records.length ? Object.keys(state.records[0]).length : 0,
          syncedAt: Date.now(),
        };
        savePersistedState();
        renderCacheDb();
        setStatus(`Loaded ${state.records.length} records (${highlightedCount} highlighted developments).`, "ok");
        addAudit("data_refreshed", `rows=${state.records.length}`);
      } catch (error) {
        console.error(error);
        setStatus(error.message, "error");
      }
    }

    async function saveProject(event) {
      event.preventDefault();
      if (!state.active) {
        setStatus("Select a project before saving.", "error");
        return;
      }

      const endpoint = document.getElementById("writeEndpoint").value.trim();
      if (!endpoint) {
        setStatus("Provide a Google Apps Script write endpoint to enable updates.", "error");
        return;
      }

      const formData = new FormData(event.target);
      const payload = Object.fromEntries(formData.entries());
      STAGE_ORDER.forEach((stage) => {
        if (!payload[stage.key]) payload[stage.key] = "Not Started";
      });
      payload.fundingSource = normalizeLender(payload.fundingSource);
      payload.drawRequested = parsePercent(payload.drawRequested);
      payload.drawApproved = parsePercent(payload.drawApproved);
      payload.criticalProgress = computeCriticalProgress(payload);

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("Save failed. Check Apps Script endpoint permissions.");

        Object.assign(state.active, payload);
        renderList(state.records);
        renderFundingScreen(state.records);
        setStatus(`Saved updates for ${payload.development || payload.address}.`, "ok");
        addAudit("project_saved", payload.development || payload.address || "row update");
      } catch (error) {
        console.error(error);
        setStatus(error.message, "error");
      }
    }

    document.getElementById("loadBtn").addEventListener("click", loadSheet);
    document.getElementById("operationsScreenBtn").addEventListener("click", () => setScreen("operations"));
    document.getElementById("fundingScreenBtn").addEventListener("click", () => setScreen("funding"));
    document.getElementById("connectionsScreenBtn").addEventListener("click", () => setScreen("connections"));
    document.getElementById("auditScreenBtn").addEventListener("click", () => setScreen("audit"));
    document.getElementById("logoutBtn").addEventListener("click", logout);
    document.getElementById("loginBtn").addEventListener("click", attemptLogin);
    document.getElementById("loginPassword").addEventListener("keydown", (event) => {
      if (event.key === "Enter") attemptLogin();
    });
    document.getElementById("saveConnectionBtn").addEventListener("click", saveConnection);
    document.getElementById("useConnectionBtn").addEventListener("click", () => {
      const conn = selectedConnection();
      if (!conn) return;
      applyConnectionToControls(conn);
      setScreen("operations");
      setStatus(`Using connection: ${conn.name}`, "ok");
    });
    document.getElementById("deleteConnectionBtn").addEventListener("click", deleteConnection);
    document.getElementById("detailsViewBtn").addEventListener("click", () => setProjectView("details"));
    document.getElementById("progressViewBtn").addEventListener("click", () => setProjectView("progress"));
    document.getElementById("detailForm").addEventListener("submit", saveProject);
    document.getElementById("reloadBtn").addEventListener("click", () => {
      if (state.active) selectProject(state.active);
    });

    loadPersistedState();
    renderConnections();
    renderCacheDb();
    renderAuditTrail();
    if (state.connections.length && !state.selectedConnectionId) {
      state.selectedConnectionId = state.connections[0].id;
      applyConnectionToControls(state.connections[0]);
    }
    setProjectView("details");
    if (state.currentUser) {
      setAuthState(true);
      addAudit("session_restore", state.currentUser.username);
      setScreen("operations");
    } else {
      setAuthState(false);
    }
  </script>
</body>
</html>

